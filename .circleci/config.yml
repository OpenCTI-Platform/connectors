#file: noinspection YAMLSchemaValidation
version: 2.1
setup: true
orbs:
  slack: circleci/slack@4.15.0
  continuation: circleci/continuation@1.1.0

executors:
  ci_environment:
    parameters:
      tags:
        type: string
        default: "rolling"
        description: Image tags
    environment:
      BUILD_TAGS: <<parameters.tags>>
    docker:
      - image: cimg/python:3.11
  ci_notifications:
    docker:
      - image: "cimg/base:stable"


jobs:
  build_manifest:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Build Connectors Schemas for XTM composer and Update Config Documentation
          command: |
              bash ./shared/tools/composer/generate_connectors_config_json_schemas.sh
      - run:
          name: Build Manifest for XTM composer
          command: |
              bash ./shared/tools/composer/generate_connectors_manifest.sh
      - run:
          name: Commit Manifest if changed
          command: |
            echo "$GITHUB_GPG_SECRET_KEY" | base64 -d > /tmp/private.key
            gpg --import /tmp/private.key
            rm /tmp/private.key
            
            git config credential.helper 'cache --timeout=120'
            git config user.email "automation@filigran.io"
            git config user.name "Filigran Automation"
            git config user.signingkey "$GITHUB_GPG_SIGNING_KEY"
            git config commit.gpgsign true
            
            if [ ! -f a ]; then
              touch a
              git add .
              git status
              git commit -m "Test the creation of a commit by Filigran-Automation with the fix (with 'verified' signature)."
              git push -q https://${GITHUB_TOKEN}@github.com/OpenCTI-Platform/connectors.git ${CIRCLE_BRANCH}
            fi
      - run:
          name: Skip steps if flag detected
          command: |
            if git log -1 --pretty=%B | grep -q '\[ci build-manifest\]'; then
              echo "Skipping steps due to [ci build-manifest] flag."
              exit 0
            fi

workflows:
  connectors:
    jobs:
      - build_manifest:
          filters:
            tags:
              only: /.*/
