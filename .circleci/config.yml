version: 2.1
setup: true
orbs:
  slack: circleci/slack@4.15.0
  ms-teams: cloudradar-monitoring/ms-teams@0.0.1
  continuation: circleci/continuation@1

jobs:
  ensure_formatting:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/repo
    steps:
      - checkout
      - run: sudo apt-get update -qq && sudo apt install curl gettext-base
      - run:
          name: install dependencies
          command: pip install black isort --user
      - run:
          name: confirm black version
          command: black --version
      - run:
          name: run isort check
          command: isort --profile black --check .
      - run:
          name: run black check
          command: black --check .
      - slack/notify:
          event: fail
          template: basic_fail_1
      - ms-teams/report:
          only_on_fail: true
          webhook_url: $MS_TEAMS_WEBHOOK_URL
  base_linter:
    docker:
      - image: alpine/flake8
    working_directory: ~/repo
    steps:
      - checkout
      - run: apk update && apk upgrade && apk --no-cache add curl gettext
      - run:
          name: flake8
          command: flake8 --ignore=E,W ~/repo
      - slack/notify:
          event: fail
          template: basic_fail_1
      - ms-teams/report:
          only_on_fail: true
          webhook_url: $MS_TEAMS_WEBHOOK_URL
  linter:
    docker:
      - image: cimg/python:3.12
    working_directory: ~/repo
    steps:
      - checkout
      - run: sudo apt-get update -qq && sudo apt install curl gettext-base
      - run:
          name: install dependencies
          command: pip install -r ./shared/pylint_plugins/check_stix_plugin/requirements.txt
      - run:
          name: pylint
          command: cd ./shared/pylint_plugins/check_stix_plugin && PYTHONPATH=. python -m pylint ../../../ --disable=all --enable=no_generated_id_stix,no-value-for-parameter,unused-import --load-plugins linter_stix_id_generator
      - slack/notify:
          event: fail
          template: basic_fail_1
      - ms-teams/report:
          only_on_fail: true
          webhook_url: $MS_TEAMS_WEBHOOK_URL
  test:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/repo
    steps:
      - checkout
      - run: sudo apt-get update -qq && sudo apt install curl gettext-base
      - run:
          name: install dependencies
          command: pip install pytest --user
      - run:
          name: Run tests
          command: bash run_test.sh
  build:
    parameters:
      tags:
        type: string
        default: "latest,rolling"
        description: Image tags
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install -r .circleci/scripts/requirements.txt
      - run:
          name: Execute Python Script
          environment:
            BUILD_TAGS: <<parameters.tags>>
          command: python .circleci/scripts/generate_ci.py

      - continuation/continue:
          configuration_path: dynamic.yml

      - slack/notify:
          event: fail
          template: basic_fail_1
      - ms-teams/report:
          only_on_fail: true
          webhook_url: $MS_TEAMS_WEBHOOK_URL

  notify_rolling:
    docker:
      - image: "cimg/base:stable"
    steps:
      - run: sudo apt-get update -qq && sudo apt install curl gettext-base
      - slack/notify:
          event: pass
          template: basic_success_1
      - ms-teams/report:
          only_on_fail: false
          webhook_url: $MS_TEAMS_WEBHOOK_URL
  notify:
    docker:
      - image: "cimg/base:stable"
    steps:
      - run: sudo apt-get update -qq && sudo apt install curl gettext-base
      - slack/notify:
          event: pass
          template: basic_success_1
      - ms-teams/report:
          only_on_fail: false
          webhook_url: $MS_TEAMS_WEBHOOK_URL
workflows:
  version: 2
  opencti:
    jobs:
 #     - ensure_formatting
 #     - base_linter
 #     - linter
 #     - test
      - build:
          name: "Build release images"
#          filters:
#            tags:
#              only: /[0-9]+(\.[0-9]+)+(\.[0-9]+)*/
#            branches:
#              ignore: /.*/
#      - build_fips:
#          filters:
#            tags:
#              only: /[0-9]+(\.[0-9]+)+(\.[0-9]+)*/
#            branches:
#              ignore: /.*/
      - build:
          name: "Build rolling images"
          tags: "rolling,latest,pre-release"
          requires:
            - ensure_formatting
            - base_linter
            - linter
          filters:
            branches:
              only:
                - master
      - build_fips_rolling:
          requires:
            - ensure_formatting
            - base_linter
            - linter
          filters:
            branches:
              only:
                - master
#      - notify_rolling:
#          requires:
#            - build_rolling # TODO: Fix it
#            - build_fips_rolling
#      - notify:
#          requires:
#            - build
#            - build_fips
#          filters:
#            tags:
#              only: /[0-9]+(\.[0-9]+)+(\.[0-9]+)*/
#            branches:
#              ignore: /.*/#
