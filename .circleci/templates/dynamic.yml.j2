version: 2.1

jobs:
{% for top_dir, sub_dirs in dirs.items() -%}
{% for sub_dir in sub_dirs %}
  build_{{top_dir}}_{{sub_dir}}:
    docker:
      - image: cimg/base:stable-20.04
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build {{top_dir}}/{{sub_dir}}
          command: |
            echo "Processing {{top_dir}}/{{sub_dir}}"
            cd {{top_dir}}/{{sub_dir}}
            docker run --privileged --rm tonistiigi/binfmt --install linux/amd64,linux/arm64
            CIRCLE_TAG=${CIRCLE_TAG:-latest}
            docker buildx create --use --name mybuilder
            docker buildx inspect mybuilder --bootstrap
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            {% set image_key = top_dir ~ '_' ~ sub_dir -%}

            {% if param['images'][image_key] is defined -%}
            base_image="{{repo}}/client-python-{{param['images'][image_key].python}}:{{version}}"
            {% else -%}
            base_image="{{repo}}/client-python-3-12:{{version}}"
            {% endif -%}

            {% if pycti.replace -%}
            find . -name requirements.txt -exec sed 's|^pycti==.*$|pycti=={{pycti.version}}|' -i {} \;
            {% endif -%}
            docker buildx build . \
             {% for tag in tags -%}
             --tag {{repo}}/connector-{{sub_dir}}:{{tag}} \
             {% endfor -%}

             {% if param['images'][image_key] is defined and param['images'][image_key]['fips'] == true -%}
            docker buildx build -f Dockerfile_fips . \
             {% for tag in tags -%}
             --tag {{repo}}/connector-{{sub_dir}}:{{tag}}-fips \
             {% endfor -%}
             --build-arg BASE_IMAGE=$base_image
             {% endif -%}
            docker buildx imagetools inspect {{repo}}/connector-{{sub_dir}} --format '{{Name}}'

      {% endfor %}
{% endfor %}
workflows:
  version: 2
  build_all:
    jobs:
  {%- for top_dir, sub_dirs in dirs.items() -%}
  {%- for sub_dir in sub_dirs %}
      - build_{{top_dir}}_{{sub_dir}}
  {%- endfor -%}
{% endfor-%}
