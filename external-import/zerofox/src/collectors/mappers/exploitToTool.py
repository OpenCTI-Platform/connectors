from typing import List, Union

import pycti
from open_cti import relationship, tool, vulnerability
from stix2 import Relationship, Tool, Vulnerability
from zerofox.domain.exploits import Exploit


def exploit_to_tool(
    created_by, now: str, entry: Exploit
) -> List[Union[Tool, Vulnerability, Relationship]]:
    """
    Creates a STIX Tool/exploitation object from a ZeroFOX Exploit object, along with
        - A Vulnerability object for the tagetted CVE
    """
    tool_entry = tool(
        id=pycti.Tool.generate_id(entry.cve),
        name=f"Exploit tool against {entry.cve}",
        description=f"```{entry.exploit}```",
        created=now,
        urls=[entry.urls],
        tool_types=["exploitation"],
        created_by_ref=created_by,
    )
    vuln = vulnerability(
        id=pycti.Vulnerability.generate_id(entry.cve),
        created_by_ref=created_by,
        cve=entry.cve,
        created=now,
        modified=now,
    )

    return [
        tool_entry,
        vuln,
        relationship(
            source=tool_entry.id,
            target=vuln.id,
            type="targets",
        ),
    ]
