from typing import List, Union

from open_cti import domain_object
from stix2 import ExternalReference, Relationship, Tool, Vulnerability
from zerofox.domain.exploits import Exploit


def exploit_to_tool(
    created_by, now: str, entry: Exploit
) -> List[Union[Tool, Vulnerability, Relationship]]:
    """
    Creates a STIX Tool/exploitation object from a ZeroFOX Exploit object, along with
        - A Vulnerability object for the tagetted CVE
    """
    tool = domain_object(
        created_by=created_by,
        cls=Tool,
        name=f"{entry.cve}",
        description=f"```{entry.exploit}```",
        created=now,
        external_references=[
            ExternalReference(source_name="link", url=url) for url in entry.urls
        ],
        tool_types=["exploitation"],
    )
    vulnerability = domain_object(
        created_by=created_by, cls=Vulnerability, name=entry.cve
    )

    return [
        tool,
        vulnerability,
        Relationship(
            source_ref=tool.id,
            target_ref=vulnerability.id,
            relationship_type="targets",
            start_time=entry.created_at,
        ),
    ]
