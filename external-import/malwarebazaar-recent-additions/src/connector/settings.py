from datetime import timedelta

from connectors_sdk import (
    BaseConfigModel,
    BaseConnectorSettings,
    BaseExternalImportConnectorConfig,
    ListFromString,
)
from pydantic import Field, SecretStr


class ExternalImportConnectorConfig(BaseExternalImportConnectorConfig):
    """
    Override the `BaseExternalImportConnectorConfig` to add parameters and/or defaults
    to the configuration for connectors of type `EXTERNAL_IMPORT`.
    """

    id: str = Field(
        description="A UUID v4 to identify the connector in OpenCTI.",
        default="338121e3-1eec-469e-acfd-35c4706306fb",
    )
    name: str = Field(
        description="The name of the connector.",
        default="MalwarebazaarRecentAdditions",
    )
    scope: ListFromString = Field(
        description="The scope of the connector.",
        default=[],
    )
    duration_period: timedelta = Field(
        description="The period of time to await between two runs of the connector.",
        default=timedelta(hours=1),
    )


class MalwarebazaarRecentAdditionsConfig(BaseConfigModel):
    """
    Define parameters and/or defaults for the configuration specific to the `MalwarebazaarRecentAdditionsConnector`.
    """

    api_url: str = Field(
        description="The URL of the MalwareBazaar API.",
        default="https://mb-api.abuse.ch/api/v1/",
    )
    api_key: SecretStr = Field(
        description="The API key for MalwareBazaar API.",
    )
    cooldown_seconds: int = Field(
        description="The time to wait in seconds between subsequent requests.",
        default=300,
    )
    include_tags: str | None = Field(
        description="Only download files if any tag matches. (Comma separated)",
        default=None,
    )
    include_reporters: str | None = Field(
        description="Only download files uploaded by these reporters. (Comma separated)",
        default=None,
    )
    labels: str | None = Field(
        description="Labels to apply to uploaded Artifacts. (Comma separated)",
        default=None,
    )
    labels_color: str = Field(
        description="Color to use for all labels.", default="#54483b"
    )


class ConnectorSettings(BaseConnectorSettings):
    """
    Override `BaseConnectorSettings` to include `ExternalImportConnectorConfig` and `MalwarebazaarRecentAdditionsConfig`.
    """

    connector: ExternalImportConnectorConfig = Field(
        default_factory=ExternalImportConnectorConfig
    )
    malwarebazaar_recent_additions: MalwarebazaarRecentAdditionsConfig = Field(
        default_factory=MalwarebazaarRecentAdditionsConfig
    )
