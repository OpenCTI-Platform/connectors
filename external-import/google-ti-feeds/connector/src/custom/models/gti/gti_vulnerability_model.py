"""Model representing a Google Threat Intelligence Vulnerability."""

from typing import Any, Dict, List, Optional, Union

from pydantic import BaseModel, Field, model_validator


class CvssV2(BaseModel):
    """Model representing a CVSS v2 score."""

    base_score: Optional[float] = Field(None, description="CVSS v2 base score.")
    temporal_score: Optional[float] = Field(None, description="CVSS v2 temporal score.")
    vector: Optional[str] = Field(None, description="CVSS v2 vector string.")


class CvssV3(BaseModel):
    """Model representing a CVSS v3 score."""

    attack_complexity: Optional[str] = Field(
        None, description="Attack complexity rating."
    )
    attack_vector: Optional[str] = Field(None, description="Attack vector description.")
    availability_impact: Optional[str] = Field(
        None, description="Impact on availability."
    )
    base_score: Optional[float] = Field(None, description="CVSS v3 base score.")
    confidentiality_impact: Optional[str] = Field(
        None, description="Impact on confidentiality."
    )
    integrity_impact: Optional[str] = Field(None, description="Impact on integrity.")
    privileges_required: Optional[str] = Field(
        None, description="Required privileges level."
    )
    scope: Optional[str] = Field(None, description="Scope of the vulnerability.")
    user_interaction: Optional[str] = Field(
        None, description="Required user interaction."
    )
    vector: Optional[str] = Field(None, description="CVSS vector string.")
    temporal_score: Optional[float] = Field(None, description="CVSS v3 temporal score.")


class CvssV4Supplemental(BaseModel):
    """Model representing a CVSS v4 supplemental score."""

    automatable: Optional[str] = Field(None, description="CVSSv4 'Automatable' metric.")
    provider_urgency: Optional[str] = Field(
        None, description="CVSSv4 'Provider Urgency' metric."
    )
    recovery: Optional[str] = Field(None, description="CVSSv4 'Recovery' metric.")
    response_effort: Optional[str] = Field(
        None, description="CVSSv4 'Vulnerability Response Effort' metric."
    )
    safety: Optional[str] = Field(None, description="CVSSv4 'Safety' metric.")
    value_density: Optional[str] = Field(
        None, description="CVSSv4 'Value Density' metric."
    )


class CvssV4Threat(BaseModel):
    """Model representing a CVSS v4 threat score."""

    exploit_maturity: Optional[str] = Field(
        None, description="CVSSv4 'Exploit Maturity' metric."
    )


class CvssV4(BaseModel):
    """Model representing a CVSS v4 score."""

    score: Optional[float] = Field(None, description="CVSSv4-BT score.")
    vector: Optional[str] = Field(None, description="Full vector of CVSSv4.")
    supplemental: Optional[CvssV4Supplemental] = Field(
        None, description="CVSSv4 supplemental object."
    )
    threat: Optional[CvssV4Threat] = Field(None, description="CVSSv4 threat object.")


class Cvss(BaseModel):
    """Model representing a CVSS score."""

    cvssv2_0: Optional[CvssV2] = Field(None, description="CVSS v2.0 object.")
    cvssv3_x: Optional[CvssV3] = Field(None, description="CVSS v3.x vector object.")
    cvssv3_x_translated: Optional[CvssV3] = Field(
        None, description="CVSS v3.x vector translated from CVSSv4."
    )
    cvssv4_x: Optional[CvssV4] = Field(None, description="CVSS v4.x object.")


class Epss(BaseModel):
    """Model representing an EPSS score."""

    score: Optional[float] = Field(
        None, description="Probability of exploitation in the next 30 days."
    )
    percentile: Optional[float] = Field(
        None, description="Percentile of EPSS score in the data."
    )


class Cwe(BaseModel):
    """Model representing a Common Weakness Enumeration (CWE) entry."""

    id: Optional[str] = Field(None, description="CWE identifier of the vulnerability.")
    title: Optional[str] = Field(
        None, description="CWE title or name of the vulnerability."
    )


class AggregationValue(BaseModel):
    """Model representing a value of an aggregation."""

    value: Union[str, Dict[str, Any], int, float, List[Any], Any] = Field(
        None, description="Value of the aggregation."
    )
    count: Optional[int] = Field(
        None, description="Number of occurrences of the aggregation value."
    )
    prevalence: Optional[float] = Field(
        None, description="Prevalence of the aggregation value."
    )


class SourceDetail(BaseModel):
    """Model representing details about the sources related to the vulnerability."""

    source_names: Optional[List[str]] = Field(
        None, description="Names of the sources related to the vulnerability."
    )


class Counters(BaseModel):
    """Dictionary of counters of related objects."""

    attack_techniques: Optional[int] = Field(
        None,
        description="Number of MITRE ATT&CK techniques associated with the vulnerability.",
    )
    domains: Optional[int] = Field(
        None, description="Number of domains related to the vulnerability."
    )
    files: Optional[int] = Field(
        None, description="Number of files related to the vulnerability."
    )
    iocs: Optional[int] = Field(
        None,
        description="Number of IoCs (files + URLs + domains + IP addresses) related to the vulnerability.",
    )
    ip_addresses: Optional[int] = Field(
        None, description="Number of IP addresses related to the vulnerability."
    )
    subscribers: Optional[int] = Field(
        None, description="Number of users subscribed to the vulnerability."
    )
    urls: Optional[int] = Field(
        None, description="Number of URLs related to the vulnerability."
    )


class SourceCvss(BaseModel):
    """CVSS information from a source."""

    cvssv2_0: Optional[CvssV2] = Field(
        None, description="CVSS v2.0 base score and vector."
    )
    cvssv3_x: Optional[CvssV3] = Field(
        None, description="CVSS v3.x base score and vector."
    )
    cvssv4_x: Optional[CvssV4] = Field(None, description="CVSS v4.x score and vector.")


class Source(BaseModel):
    """Information supplier."""

    name: Optional[str] = Field(None, description="Supplier's name.")
    unique_id: Optional[str] = Field(
        None, description="Unique identifier provided by the supplier."
    )
    md5: Optional[str] = Field(
        None, description="MD5 of url/pdf of the source when it was collected."
    )
    title: Optional[str] = Field(
        None,
        description="Title of the url/pdf from where the information was collected.",
    )
    source_description: Optional[str] = Field(
        None,
        description="Description of the url/pdf from where the information was collected.",
    )
    published_date: Optional[int] = Field(
        None,
        description="Datetime when the information was first published (UTC timestamp).",
    )
    url: Optional[str] = Field(
        None, description="URL of the source of the information."
    )
    cvss: Optional[SourceCvss] = Field(
        None, description="CVSS information from this source."
    )


class SourceRegion(BaseModel):
    """Country or region from which the vulnerability is known to originate."""

    confidence: Optional[str] = Field(
        None, description="Confidence on the information related to the source region."
    )
    country: Optional[str] = Field(
        None, description="Country from which vulnerability is known to originate."
    )
    country_iso2: Optional[str] = Field(
        None, description="Source country in ISO 3166 Alpha2 code format."
    )
    description: Optional[str] = Field(
        None, description="Additional information about the source region."
    )
    first_seen: Optional[int] = Field(
        None,
        description="First time this source region was attributed to the vulnerability (UTC timestamp).",
    )
    last_seen: Optional[int] = Field(
        None,
        description="Last time this source region was attributed to the vulnerability (UTC timestamp).",
    )
    region: Optional[str] = Field(
        None, description="Region from which the vulnerability is known to originate."
    )
    source: Optional[str] = Field(None, description="Information's supplier.")
    sub_region: Optional[str] = Field(
        None,
        description="Subregion from which the vulnerability is known to originate.",
    )
    source_urls: Optional[List[str]] = None


class CisaKnownExploited(BaseModel):
    """CISA Known Exploited Vulnerabilities."""

    added_date: Optional[int] = Field(
        None, description="Date added to KEV (UTC timestamp)."
    )
    due_date: Optional[int] = Field(
        None, description="Remediation due date (UTC timestamp)."
    )
    ransomware_use: Optional[str] = Field(
        None, description="Usage in ransomware campaigns."
    )


class AltNameDetail(BaseModel):
    """Alternative name details."""

    confidence: Optional[str] = Field(
        None, description="Confidence on attribution of the alternative name."
    )
    description: Optional[str] = Field(
        None, description="Additional information about the alternative name."
    )
    first_seen: Optional[int] = Field(
        None, description="First time this alt name was seen (UTC timestamp)."
    )
    last_seen: Optional[int] = Field(
        None, description="Last time this alt name was seen (UTC timestamp)."
    )
    value: Optional[str] = Field(None, description="The alternative name / alias.")


class CpeObject(BaseModel):
    """CPE object details."""

    product: Optional[str] = Field(None, description="Product name.")
    uri: Optional[str] = Field(None, description="CPE URI.")
    vendor: Optional[str] = Field(None, description="Vendor name.")
    version: Optional[str] = Field(None, description="Version of the product.")


class CpeRange(BaseModel):
    """CPE range details."""

    start_rel: Optional[str] = Field(None, description="Start relationship operator.")
    end_rel: Optional[str] = Field(None, description="End relationship operator.")
    start_cpe: Optional[CpeObject] = Field(None, description="Start CPE object.")
    end_cpe: Optional[CpeObject] = Field(None, description="End CPE object.")


class Aggregations(BaseModel):
    """Aggregation details."""

    domains: Optional[Dict[str, Any]] = Field(
        None, description="Technical commonalities among all related domains."
    )
    files: Optional[Dict[str, Any]] = Field(
        None, description="Technical commonalities among all related files."
    )
    ip_addresses: Optional[Dict[str, Any]] = Field(
        None, description="Technical commonalities among all related IP addresses."
    )
    urls: Optional[Dict[str, Any]] = Field(
        None, description="Technical commonalities among all related URLs."
    )


class VendorFixReference(BaseModel):
    """Vendor fix reference details."""

    cvss: Optional[str] = Field(None, description="Associated CVSS score.")
    md5: Optional[str] = Field(None, description="MD5 hash of the fix file.")
    name: Optional[str] = Field(None, description="Supplier or vendor name.")
    published_date: Optional[int] = Field(
        None, description="Publication date (UTC timestamp)."
    )
    source_description: Optional[str] = Field(None, description="Fix description.")
    title: Optional[str] = Field(
        None, description="Title of the fixâ€™s webpage or source."
    )
    unique_id: Optional[str] = Field(None, description="Unique identifier of the fix.")
    url: Optional[str] = Field(None, description="URL to the fix publication.")


class FieldSource(BaseModel):
    """Field source details."""

    field: Optional[str] = Field(
        None, description="Field name being sourced (e.g. 'description', 'cwe')."
    )
    source: Optional[Dict[str, Union[str, List[str], List[SourceDetail], None]]] = (
        Field(None, description="Information's supplier details.")
    )


class TagDetail(BaseModel):
    """Tag detail information."""

    confidence: Optional[str] = Field(
        None, description="Confidence level for tag attribution."
    )
    description: Optional[str] = Field(
        None, description="Additional context about the tag."
    )
    first_seen: Optional[int] = Field(
        None, description="When this tag was first seen (UTC timestamp)."
    )
    last_seen: Optional[int] = Field(
        None, description="When this tag was last seen (UTC timestamp)."
    )
    value: Optional[str] = Field(None, description="Tag value.")


class TargetedIndustry(BaseModel):
    """Targeted industry details."""

    confidence: Optional[str] = Field(
        None, description="Confidence in industry targeting information."
    )
    description: Optional[str] = Field(
        None, description="Additional info about industry targeted."
    )
    first_seen: Optional[int] = Field(
        None, description="First time seen (UTC timestamp)."
    )
    last_seen: Optional[int] = Field(
        None, description="Last time seen (UTC timestamp)."
    )
    source: Optional[str] = Field(None, description="Information's supplier.")
    industry: Optional[str] = Field(None, description="Sub-industry targeted.")
    industry_group: Optional[str] = Field(None, description="Industry group targeted.")


class TargetedRegion(BaseModel):
    """Targeted region details."""

    confidence: Optional[str] = Field(
        None, description="Confidence in regional targeting information."
    )
    country: Optional[str] = Field(
        None, description="Country targeted by the vulnerability."
    )
    country_iso2: Optional[str] = Field(
        None, description="Targeted country in ISO 3166 Alpha2 format."
    )
    description: Optional[str] = Field(None, description="Additional context.")
    first_seen: Optional[int] = Field(
        None, description="First time seen (UTC timestamp)."
    )
    last_seen: Optional[int] = Field(
        None, description="Last time seen (UTC timestamp)."
    )
    region: Optional[str] = Field(None, description="Region targeted.")
    sub_region: Optional[str] = Field(None, description="Sub-region targeted.")
    source: Optional[str] = Field(None, description="Information's supplier.")


class VersionHistoryEntry(BaseModel):
    """Version history entry details."""

    version_notes: Optional[List[str]] = Field(
        None, description="New information around the vulnerability."
    )
    date: Optional[int] = Field(
        None, description="Date when the information was added (UTC timestamp)."
    )


class ExplotationDetails(BaseModel):
    """Exploit details."""

    exploit_release_date: Optional[int] = Field(
        None, description="First publicly available exploit date (UTC)."
    )
    tech_details_release_date: Optional[int] = Field(
        None, description="First technical details release date (UTC)."
    )
    first_exploitation: Optional[int] = Field(
        None, description="Earliest known exploitation date (UTC)."
    )


class SummaryStatsEntry(BaseModel):
    """Summary statistics entry."""

    min: Optional[float] = Field(None, description="Minimum value.")
    max: Optional[float] = Field(None, description="Maximum value.")
    avg: Optional[float] = Field(None, description="Average value.")


class SummaryStats(BaseModel):
    """Summary statistics."""

    first_submission_date: Optional[SummaryStatsEntry] = Field(
        None, description="Stats for first_submission_date."
    )
    last_submission_date: Optional[SummaryStatsEntry] = Field(
        None, description="Stats for last_submission_date."
    )
    files_detections: Optional[SummaryStatsEntry] = Field(
        None, description="Stats for file detections."
    )
    urls_detections: Optional[SummaryStatsEntry] = Field(
        None, description="Stats for URL detections."
    )


class ActivityWindow(BaseModel):
    """Activity window."""

    confidence: Optional[str] = Field(
        None, description="Confidence level in the first/last seen attribution."
    )
    description: Optional[str] = Field(
        None, description="Description of the activity observation."
    )
    first_seen: Optional[int] = Field(
        None, description="First time this activity was seen (UTC timestamp)."
    )
    last_seen: Optional[int] = Field(
        None, description="Last time this activity was seen (UTC timestamp)."
    )
    value: Optional[str] = Field(
        None,
        description="Date of observation in ISO format (e.g., 'YYYY-MM-DDTHH:mm:ssZ').",
    )


class VulnerabilityModel(BaseModel):
    """Model representing a Google Threat Intelligence Vulnerability."""

    aggregations: Optional[Aggregations] = Field(
        None, description="IoC technical aggregations."
    )
    alt_names_details: Optional[List[AltNameDetail]] = Field(
        None, description="Alternative names for this vuln."
    )
    analysis: Optional[str] = Field(None, description="Analyst comments.")

    available_mitigation: Optional[List[str]] = Field(
        None,
        description="List of available ways to reduce / mitigate the vulnerability.",
    )
    cve_id: Optional[str] = Field(None, description="CVE identifier.")
    cvss: Optional[Cvss] = Field(None, description="CVSS scores across v2, v3, v4.")
    cisa_known_exploited: Optional[CisaKnownExploited] = Field(
        None, description="CISA Known Exploited info."
    )
    collection_type: str = Field(
        "vulnerability", description="The type of this object (always 'vulnerability')."
    )
    counters: Optional[Counters] = Field(
        None, description="Dictionary of counters of related objects."
    )
    creation_date: int = Field(..., description="UTC timestamp of object creation.")
    cwe: Optional[Cwe] = Field(None, description="CWE classification.")
    date_of_disclosure: Optional[int] = Field(None, description="UTC disclosure date.")
    days_to_report: Optional[int] = Field(
        None, description="Days between disclosure and publication."
    )
    description: Optional[str] = Field(
        None, description="Context or summary about the vulnerability."
    )
    cpes: Optional[List[CpeRange]] = Field(
        None, description="CPE product objects affected by this vuln."
    )
    epss: Optional[Epss] = Field(None, description="Exploit Prediction Scoring System.")
    executive_summary: Optional[str] = Field(
        None, description="Executive-level summary."
    )
    exploitation: Optional[ExplotationDetails] = Field(
        None, description="Detailed timeline of exploitation."
    )
    exploit_availability: Optional[str] = Field(
        None, description="Exploit availability: Known, Public, etc."
    )
    exploitation_consequence: Optional[str] = Field(
        None, description="Impact of exploiting this vulnerability."
    )
    exploitation_state: Optional[str] = Field(
        None, description="Status of exploitation in the wild."
    )
    exploitation_vectors: Optional[List[str]] = Field(
        None, description="Vectors through which vuln is exploited."
    )
    field_sources: Optional[List[FieldSource]] = Field(
        None, description="Attribution sources for key fields."
    )
    first_seen_details: Optional[List[ActivityWindow]] = Field(
        None, description="When activity was first observed."
    )
    last_modification_date: int = Field(
        ..., description="UTC timestamp of last update."
    )
    last_seen_details: Optional[List[ActivityWindow]] = Field(
        None, description="When activity was last observed."
    )
    mve_id: Optional[str] = Field(
        None, description="Mandiant Vulnerability and Exposure ID."
    )
    name: str = Field(..., description="Vulnerability's name.")
    origin: Optional[str] = Field(
        None, description="Information origin, e.g. 'Google Threat Intelligence'."
    )
    predicted_risk_rating: Optional[str] = Field(
        None,
        description="Vulnerability's predicted risk rating: Low, Medium, High, None.",
    )
    private: bool = Field(False, description="Whether this object is private.")
    priority: Optional[str] = Field(None, description="Priority of the remediation.")
    recent_activity_relative_change: Optional[float] = Field(
        None, description="Ratio change of recent activity."
    )
    recent_activity_summary: Optional[List[int]] = Field(
        None, description="14-day activity histogram."
    )
    risk_factors: Optional[List[str]] = Field(
        None,
        description="List of factors that impacted the vulnerability's risk_rating.",
    )
    risk_rating: Optional[str] = Field(
        None, description="Risk rating: Low, Medium, High, Critical, Unrated."
    )
    sources: Optional[List[Source]] = Field(
        None, description="List of information's suppliers."
    )
    source_regions_hierarchy: Optional[List[SourceRegion]] = Field(
        None, description="Country or region from which the vulnerability originates."
    )
    status: Optional[str] = Field(
        None, description="Object status: PENDING_RECOMPUTE or COMPUTED."
    )
    summary_stats: Optional[SummaryStats] = Field(
        None, description="Statistical summary of indicators."
    )
    tags: Optional[List[str]] = Field(None, description="List of tags.")
    tags_details: Optional[List[TagDetail]] = Field(
        None, description="Detailed tags with confidence and timestamps."
    )
    targeted_industries_tree: Optional[List[TargetedIndustry]] = Field(
        None, description="Industries affected."
    )
    targeted_regions_hierarchy: Optional[List[TargetedRegion]] = Field(
        None, description="Regions targeted."
    )
    vendor_fix_references: Optional[List[VendorFixReference]] = Field(
        None, description="References to available fixes."
    )
    version_history: Optional[List[VersionHistoryEntry]] = Field(
        None, description="List of previous updates."
    )
    workarounds: Optional[List[str]] = Field(
        None,
        description="List of strings explaining vulnerability's workaround / alternative fixes.",
    )


class Links(BaseModel):
    """Model representing links to related resources."""

    self: str
    next: Optional[str] = Field(None, description="Link to the next page of results.")


class GTIVulnerabilityMeta(BaseModel):
    """Model representing metadata for a GTI threat actor."""

    count: int
    cursor: Optional[str] = Field(None, description="Cursor for pagination.")


class GTIVulnerabilityData(BaseModel):
    """Model representing data for a GTI vulnerability."""

    id: str
    type: Optional[str] = None
    links: Optional[Links] = None
    attributes: Optional[VulnerabilityModel] = None


class GTIVulnerabilityResponse(BaseModel):
    """Model representing a response containing GTI vulnerability data."""

    data: List[GTIVulnerabilityData]
    meta: Optional[GTIVulnerabilityMeta] = Field(
        default=None,
        description="Metadata for the response. May be absent when no data is returned.",
    )
    links: Links

    @model_validator(mode="before")
    @classmethod
    def validate_data_structure(cls, values: Any) -> Any:
        """Ensure data field is properly structured."""
        if isinstance(values, dict) and "data" in values:
            data = values["data"]
            if not isinstance(data, list):
                values["data"] = [data] if data is not None else []
            else:
                valid_items = []
                for item in data:
                    if isinstance(item, dict) and "id" in item:
                        valid_items.append(item)
                values["data"] = valid_items
        return values
