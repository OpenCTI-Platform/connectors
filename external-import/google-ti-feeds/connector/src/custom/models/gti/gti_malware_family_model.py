"""Model representing a Google Threat Intelligence Malware Family."""

from typing import Any

from pydantic import BaseModel, Field


class AggregationCommonalities(BaseModel):
    """Technical commonalities among all domains, files, IP addresses, and URLs tied to the malware family."""

    domains: dict[str, Any] | None = Field(
        None,
        description="Technical commonalities among all domains tied to the malware family.",
    )
    files: dict[str, Any] | None = Field(
        None,
        description="Technical commonalities among all files tied to the malware family.",
    )
    ip_addresses: dict[str, Any] | None = Field(
        None,
        description="Technical commonalities among all IP addresses tied to the malware family.",
    )
    urls: dict[str, Any] | None = Field(
        None,
        description="Technical commonalities among all URLs tied to the malware family.",
    )


class Counters(BaseModel):
    """Count of technical commonalities among all domains, files, IP addresses, and URLs tied to the malware family."""

    attack_techniques: int = Field(
        ...,
        description="Number of MITRE ATT&CK techniques associated with the malware family.",
    )
    domains: int = Field(
        ..., description="Number of domains related to the malware family."
    )
    files: int = Field(
        ..., description="Number of files related to the malware family."
    )
    iocs: int = Field(
        ...,
        description="Number of IoCs related to the malware family (files + URLs + domains + IP addresses).",
    )
    ip_addresses: int = Field(
        ..., description="Number of IP addresses related to the malware family."
    )
    subscribers: int = Field(
        ..., description="Number of users subscribed to the malware family."
    )
    urls: int = Field(..., description="Number of URLs related to the malware family.")


class AltNameDetail(BaseModel):
    """Alternative names/aliases by which the malware family could be known."""

    confidence: str = Field(
        ...,
        description="Confidence on the information or the attribution of the alternative name.",
    )
    description: str | None = Field(
        None, description="Additional information related to the alternative name."
    )
    first_seen: int | None = Field(
        None,
        description="The first time the alternative name was attributed (UTC timestamp).",
    )
    last_seen: int | None = Field(
        None,
        description="The last time the alternative name was attributed (UTC timestamp).",
    )
    value: str = Field(..., description="Alternative name/alias.")


class Capability(BaseModel):
    """Capabilities associated with malware family's files."""

    confidence: str = Field(
        ..., description="The confidence of the malware family's associated capability."
    )
    description: str | None = Field(None, description="Description of the capability.")
    first_seen: int | None = Field(
        None, description="First time the capability was associated (UTC timestamp)."
    )
    last_seen: int | None = Field(
        None, description="Last time the capability was associated (UTC timestamp)."
    )
    value: str = Field(..., description="Capability name.")


class DetectionName(BaseModel):
    """External detection names associated with the malware family."""

    confidence: str = Field(
        ...,
        description="The confidence of the detection name associated to the malware family.",
    )
    description: str | None = Field(
        None, description="Descriptive information related to the detection name."
    )
    first_seen: int | None = Field(
        None,
        description="First time the detection name was associated (UTC timestamp).",
    )
    last_seen: int | None = Field(
        None, description="Last time the detection name was associated (UTC timestamp)."
    )
    value: str = Field(..., description="The detection name.")


class SeenDetail(BaseModel):
    """Details about when the malware family was first or last seen."""

    confidence: str = Field(
        ..., description="Confidence on the information or the attribution."
    )
    description: str | None = Field(
        None, description="Additional information about the activity."
    )
    first_seen: int | None = Field(
        None, description="First time this date was attributed (UTC timestamp)."
    )
    last_seen: int | None = Field(
        None, description="Last time this date was attributed (UTC timestamp)."
    )
    value: str = Field(
        ...,
        description="Date when the observation was made (YYYY-MM-DDTHH:mm:ssZ format).",
    )


class MalwareRole(BaseModel):
    """Malware roles associated with the malware family."""

    confidence: str = Field(
        ..., description="The confidence of the malware family's associated role."
    )
    description: str | None = Field(
        None, description="Descriptive information related to the role."
    )
    first_seen: int | None = Field(
        None, description="First time the role was associated (UTC timestamp)."
    )
    last_seen: int | None = Field(
        None, description="Last time the role was associated (UTC timestamp)."
    )
    value: str = Field(..., description="The malware role name.")


class OperatingSystem(BaseModel):
    """Operating systems affected by the malware family."""

    confidence: str = Field(
        ..., description="The confidence that the OS is affected by the malware family."
    )
    description: str | None = Field(
        None, description="Descriptive information related to the targeted OS."
    )
    first_seen: int | None = Field(
        None, description="First time the OS was associated (UTC timestamp)."
    )
    last_seen: int | None = Field(
        None, description="Last time the OS was associated (UTC timestamp)."
    )
    value: str = Field(..., description="Operating system name.")


class SourceRegion(BaseModel):
    """Country or region from which the malware family is known to originate."""

    confidence: str = Field(
        ...,
        description="Confidence on the information related to the source region.",
    )
    country: str | None = Field(None, description="Country of malware family origin.")
    country_iso2: str | None = Field(
        None, description="Source country in ISO 3166 Alpha2 code format."
    )
    description: str | None = Field(
        None, description="Additional information about the source region."
    )
    first_seen: int | None = Field(
        None,
        description="First time this source region was attributed (UTC timestamp).",
    )
    last_seen: int | None = Field(
        None, description="Last time this source region was attributed (UTC timestamp)."
    )
    region: str | None = Field(None, description="Region of malware family origin.")
    source: str | None = Field(None, description="Information's supplier.")
    sub_region: str | None = Field(
        None, description="Subregion of malware family origin."
    )


class TagDetail(BaseModel):
    """Tags associated with the malware family with additional context."""

    confidence: str = Field(
        ..., description="Confidence on the tag association to the malware family."
    )
    description: str | None = Field(
        None, description="Additional information related to the tag."
    )
    first_seen: int | None = Field(
        None, description="First time this tag was attributed (UTC timestamp)."
    )
    last_seen: int | None = Field(
        None, description="Last time this tag was attributed (UTC timestamp)."
    )
    value: str = Field(..., description="Value of the tag.")


class TargetedIndustry(BaseModel):
    """Industries and industry groups known to be targeted by the malware family."""

    confidence: str = Field(
        ..., description="Confidence on the industry targeted by the malware family."
    )
    description: str | None = Field(
        None, description="Additional information related to the targeted industry."
    )
    first_seen: int | None = Field(
        None,
        description="First time this targeted industry was associated (UTC timestamp).",
    )
    industry: str | None = Field(
        None, description="Sub-industry targeted by the malware family."
    )
    industry_group: str = Field(
        ..., description="Industry group targeted by the malware family."
    )
    last_seen: int | None = Field(
        None,
        description="Last time this targeted industry was associated (UTC timestamp).",
    )
    source: str | None = Field(None, description="Information's supplier.")


class TargetedRegion(BaseModel):
    """Regions and countries known to be targeted by the malware family."""

    confidence: str = Field(
        ...,
        description="Confidence on the malware family's targeted region association.",
    )
    country: str | None = Field(
        None, description="Country targeted by the malware family."
    )
    country_iso2: str | None = Field(
        None, description="Targeted country in ISO 3166 Alpha2 code format."
    )
    description: str | None = Field(
        None, description="Additional information related to the targeted region."
    )
    first_seen: int | None = Field(
        None,
        description="First time this targeted region was associated (UTC timestamp).",
    )
    last_seen: int | None = Field(
        None,
        description="Last time this targeted region was associated (UTC timestamp).",
    )
    region: str | None = Field(
        None, description="Region targeted by the malware family."
    )
    source: str | None = Field(None, description="Information's supplier.")
    sub_region: str | None = Field(
        None, description="Sub-region targeted by the malware family."
    )


class MalwareFamilyModel(BaseModel):
    """Model representing a GTI malware family."""

    name: str = Field(..., description="Malware family's name.")
    collection_type: str | None = Field(
        None,
        description="Type of object; typically 'malware-family' or 'malware_family'",
    )
    creation_date: int = Field(
        ..., description="UTC timestamp of malware family object creation."
    )
    last_modification_date: int = Field(
        ..., description="UTC timestamp of last malware family update."
    )
    description: str | None = Field(
        None, description="Description/context about the malware family."
    )
    status: str | None = Field(
        None,
        description="Status of attribute computation: PENDING_RECOMPUTE or COMPUTED.",
    )
    private: bool = Field(
        ..., description="Whether the malware family object is private."
    )
    origin: str | None = Field(
        None,
        description="Source of the information: Partner or Google Threat Intelligence.",
    )

    recent_activity_relative_change: float | None = Field(
        None, description="Ratio of recent activity change (14-day interval)."
    )
    recent_activity_summary: list[int] | None = Field(
        None, description="Time series of IoC activity (14-day)."
    )
    top_icon_md5: list[str] | None = Field(
        None, description="list of the 3 most frequent icons' MD5 hashes."
    )

    counters: Counters | None = Field(
        None, description="Counters for related indicators and metadata."
    )
    aggregations: AggregationCommonalities | None = Field(
        None, description="Grouped common traits across related IoCs."
    )
    alt_names_details: list[AltNameDetail] | None = Field(
        None, description="Alternative names/aliases for the malware family."
    )
    capabilities: list[Capability] | None = Field(
        None, description="Capabilities associated with the malware family's files."
    )
    detection_names: list[DetectionName] | None = Field(
        None, description="External detection names associated with the malware family."
    )
    first_seen_details: list[SeenDetail] | None = Field(
        None, description="Information about when the malware family was first seen."
    )
    last_seen_details: list[SeenDetail] | None = Field(
        None, description="Information about when the malware family was last seen."
    )
    malware_roles: list[MalwareRole] | None = Field(
        None, description="Roles associated with the malware family."
    )
    operating_systems: list[OperatingSystem] | None = Field(
        None, description="Operating systems affected by the malware family."
    )
    source_regions_hierarchy: list[SourceRegion] | None = Field(
        None, description="Regions/countries of malware family origin."
    )
    tags_details: list[TagDetail] | None = Field(
        None, description="Tags applied to the malware family, with context."
    )
    targeted_industries_tree: list[TargetedIndustry] | None = Field(
        None, description="Industries targeted by the malware family."
    )
    targeted_regions_hierarchy: list[TargetedRegion] | None = Field(
        None, description="Regions/countries targeted by the malware family."
    )


class Links(BaseModel):
    """Model representing links to related resources."""

    self: str
    next: str | None = Field(None, description="Link to the next page of results.")


class GTIMalwareFamilyMeta(BaseModel):
    """Model representing metadata for a GTI malware family."""

    count: int
    cursor: str | None = Field(None, description="Cursor for pagination.")


class GTIMalwareFamilyData(BaseModel):
    """Model representing data for a GTI malware family."""

    id: str
    type: str | None = None
    links: dict[str, str] | None = None
    attributes: MalwareFamilyModel | None = None
    context_attributes: dict[str, Any] | None = None


class GTIMalwareFamilyResponse(BaseModel):
    """Model representing a response containing GTI malware family data."""

    data: GTIMalwareFamilyData | list[GTIMalwareFamilyData]
    meta: GTIMalwareFamilyMeta | None = Field(
        default=None,
        description="Metadata for the response. May be absent when no data is returned.",
    )
    links: Links
