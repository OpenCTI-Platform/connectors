# -*- coding: utf-8 -*-
"""Test for removing CrowdStrike capabilities mapping from malware entities.

Feature: Remove the mapping of "capabilities" coming from crowdstrike as they can't be mapped as OpenCTI capabilities
  As a Threat Intel Analyst
  I want to remove the mapping of "capabilities" coming from crowdstrike
  Because they can't be mapped as OpenCTI capabilities
"""

import json
from unittest.mock import Mock

import pytest
from crowdstrike_feeds_connector.malware.builder import MalwareBundleBuilder
from crowdstrike_feeds_services.utils import create_organization
from crowdstrike_feeds_services.utils.constants import DEFAULT_TLP_MARKING_DEFINITION

# =====================
# Fixtures
# =====================


@pytest.fixture
def fake_malware_data():
    """Load fake malware data from JSON file."""
    import os

    faker_path = os.path.join(
        os.path.dirname(__file__), "..", "faker", "api_malware.json"
    )
    with open(faker_path, "r") as f:
        data = json.load(f)
    return data["resources"][0]


@pytest.fixture
def author_identity():
    """Fixture for author identity."""
    return create_organization("CrowdStrike")


@pytest.fixture
def tlp_marking():
    """Fixture for TLP marking."""
    return DEFAULT_TLP_MARKING_DEFINITION


@pytest.fixture
def mock_helper():
    """Fixture for mock OpenCTI helper."""
    return Mock()


# =====================
# Test Cases
# =====================


@pytest.mark.order(0)
def test_ingest_malware_without_capabilities_mapping(
    fake_malware_data, author_identity, tlp_marking
):
    """
    Feature: Remove the mapping of "capabilities" coming from crowdstrike as they can't be mapped as OpenCTI capabilities
      As a Threat Intel Analyst
      I want to remove the mapping of "capabilities" coming from crowdstrike
      Because they can't be mapped as OpenCTI capabilities

    Scenario: Ingest malware data without mapping "capabilities"
    """
    # Given a malware object with "capabilities" from CrowdStrike
    malware_data = _given_malware_with_capabilities(fake_malware_data)

    # When the malware object is ingested into the system
    bundle = _when_malware_is_ingested(malware_data, author_identity, tlp_marking)

    # Then the "capabilities" field should not be mapped to OpenCTI capabilities
    _then_capabilities_not_mapped_to_opencti(bundle, malware_data)


# =====================
# GWT Gherkin-style functions
# =====================


def _given_malware_with_capabilities(malware_data: dict) -> dict:
    """Given a malware object with "capabilities" from CrowdStrike."""
    assert "capabilities" in malware_data  # noqa: S101
    assert len(malware_data["capabilities"]) > 0  # noqa: S101

    assert "InformationStealer" in malware_data["capabilities"]  # noqa: S101

    return malware_data


def _when_malware_is_ingested(malware_data: dict, author, tlp_marking):
    """When the malware object is ingested into the system."""
    bundle_builder = MalwareBundleBuilder(
        malware=malware_data,
        author=author,
        source_name="CrowdStrike",
        object_markings=[tlp_marking],
        confidence_level=75,
        attack_patterns=[],
    )

    bundle = bundle_builder.build()
    return bundle


def _then_capabilities_not_mapped_to_opencti(bundle, malware_data: dict) -> None:
    """Then the "capabilities" field should not be mapped to OpenCTI capabilities."""
    malware_entities = [obj for obj in bundle.objects if obj.type == "malware"]

    assert len(malware_entities) == 1  # noqa: S101

    malware_entity = malware_entities[0]

    assert malware_entity["name"] == malware_data["name"]  # noqa: S101

    if hasattr(malware_entity, "capabilities"):
        assert (
            malware_entity.capabilities is None or len(malware_entity.capabilities) == 0
        )  # noqa: S101
    else:
        assert not hasattr(malware_entity, "capabilities")  # noqa: S101

    assert len(malware_data["capabilities"]) > 0  # noqa: S101
