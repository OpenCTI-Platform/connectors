"""Test for mapping CrowdStrike kill chain phases to OpenCTI kill chain phases.

Feature: Add mapping for the Kill Chain phases coming from CrowdStrike to OpenCTI Kill Chain Phases
  As a Threat Intel Analyst
  I want to map the Kill Chain phases coming from CrowdStrike to OpenCTI Kill Chain Phases
  Because it will enhance the threat intelligence data model
"""

import json

import pytest
from crowdstrike_feeds_connector.malware.builder import MalwareBundleBuilder
from crowdstrike_feeds_services.utils import create_organization
from crowdstrike_feeds_services.utils.constants import DEFAULT_TLP_MARKING_DEFINITION

# =====================
# Fixtures
# =====================


@pytest.fixture
def fake_malware_data():
    """Load fake malware data from JSON file."""
    import os

    faker_path = os.path.join(
        os.path.dirname(__file__), "..", "faker", "api_malware.json"
    )
    with open(faker_path, "r") as f:
        data = json.load(f)
    return data["resources"][0]


@pytest.fixture
def author_identity():
    """Fixture for author identity."""
    return create_organization("CrowdStrike")


@pytest.fixture
def tlp_marking():
    """Fixture for TLP marking."""
    return DEFAULT_TLP_MARKING_DEFINITION


# =====================
# Test Cases
# =====================


@pytest.mark.order(0)
def test_ingest_malware_with_kill_chain_mapping(
    fake_malware_data, author_identity, tlp_marking
):
    """
    Feature: Add mapping for the Kill Chain phases coming from CrowdStrike to OpenCTI Kill Chain Phases
      As a Threat Intel Analyst
      I want to map the Kill Chain phases coming from CrowdStrike to OpenCTI Kill Chain Phases
      Because it will enhance the threat intelligence data model

    Scenario: Ingest malware data with mapped Kill Chain phases
    """
    # Given a malware object with Kill Chain phases from CrowdStrike
    malware_data = _given_malware_with_kill_chain_phases(fake_malware_data)

    # When the malware object is ingested into the system
    bundle = _when_malware_is_ingested(malware_data, author_identity, tlp_marking)

    # Then the Kill Chain phases should be mapped to OpenCTI Kill Chain Phases
    _then_kill_chain_phases_mapped_to_opencti(bundle, malware_data)


# =====================
# GWT Gherkin-style functions
# =====================


def _given_malware_with_kill_chain_phases(malware_data: dict) -> dict:
    """Given a malware object with Kill Chain phases from CrowdStrike."""
    assert "kill_chain" in malware_data  # noqa: S101
    assert len(malware_data["kill_chain"]) > 0  # noqa: S101

    assert "Delivery" in malware_data["kill_chain"]  # noqa: S101
    assert "ActionOnObjectives" in malware_data["kill_chain"]  # noqa: S101

    return malware_data


def _when_malware_is_ingested(malware_data: dict, author, tlp_marking):
    """When the malware object is ingested into the system."""
    bundle_builder = MalwareBundleBuilder(
        malware=malware_data,
        author=author,
        source_name="CrowdStrike",
        object_markings=[tlp_marking],
        confidence_level=75,
        attack_patterns=[],
    )

    bundle = bundle_builder.build()
    return bundle


def _then_kill_chain_phases_mapped_to_opencti(bundle, malware_data: dict) -> None:
    """Then the Kill Chain phases should be mapped to OpenCTI Kill Chain Phases."""
    malware_entities = [obj for obj in bundle.objects if obj.type == "malware"]

    assert len(malware_entities) == 1  # noqa: S101

    malware_entity = malware_entities[0]

    assert malware_entity["name"] == malware_data["name"]  # noqa: S101

    assert hasattr(malware_entity, "kill_chain_phases")  # noqa: S101
    assert malware_entity.kill_chain_phases is not None  # noqa: S101
    assert len(malware_entity.kill_chain_phases) > 0  # noqa: S101

    kill_chain_phase_names = [
        kcp.phase_name for kcp in malware_entity.kill_chain_phases
    ]
    kill_chain_names = [kcp.kill_chain_name for kcp in malware_entity.kill_chain_phases]

    for kill_chain_name in kill_chain_names:
        assert kill_chain_name == "lockheed-martin-cyber-kill-chain"  # noqa: S101

    if "Delivery" in malware_data["kill_chain"]:
        assert "delivery" in kill_chain_phase_names  # noqa: S101

    if "ActionOnObjectives" in malware_data["kill_chain"]:
        assert "action-on-objectives" in kill_chain_phase_names  # noqa: S101

    assert len(malware_entity.kill_chain_phases) == len(
        malware_data["kill_chain"]
    )  # noqa: S101

    for kill_chain_phase in malware_entity.kill_chain_phases:
        assert hasattr(kill_chain_phase, "kill_chain_name")  # noqa: S101
        assert hasattr(kill_chain_phase, "phase_name")  # noqa: S101
        assert (
            kill_chain_phase.kill_chain_name == "lockheed-martin-cyber-kill-chain"
        )  # noqa: S101
