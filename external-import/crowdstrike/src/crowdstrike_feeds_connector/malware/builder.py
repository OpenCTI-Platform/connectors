# -*- coding: utf-8 -*-
"""OpenCTI CrowdStrike malware builder module."""

from typing import Any, List, Optional

from crowdstrike_feeds_services.utils import (
    create_external_reference,
    create_malware,
    create_sector,
    create_targets_relationships,
    create_uses_relationships,
    flexible_timestamp_to_datetime,
    remove_html_tags,
)
from stix2 import Identity  # type: ignore
from stix2 import (
    AttackPattern,
    Bundle,
    ExternalReference,
    Malware,
    MarkingDefinition,
    Relationship,
)
from stix2.v21 import _DomainObject  # type: ignore


class MalwareBundleBuilder:
    """Malware bundle builder."""

    def __init__(
        self,
        malware: dict,
        author: Identity,
        source_name: str,
        object_markings: List[MarkingDefinition],
        confidence_level: int,
        attack_patterns: Optional[List] = None,
    ) -> None:
        """Initialize malware bundle builder."""
        self.malware = malware
        self.author = author
        self.source_name = source_name
        self.object_markings = object_markings
        self.confidence_level = confidence_level
        self.attack_patterns = attack_patterns or []

        created_ts = self.malware["created_timestamp"]
        self.created_timestamp = flexible_timestamp_to_datetime(created_ts)

        last_updated = self.malware["last_updated"]
        self.modified_timestamp = flexible_timestamp_to_datetime(last_updated)

    def _create_external_references(self) -> List[ExternalReference]:
        external_references = []

        malware_slug = self.malware.get("slug")
        if malware_slug:
            malware_url = f"https://falcon.us-2.crowdstrike.com/intelligence-v2/finished-intelligence/malware/{malware_slug}"
            external_reference = create_external_reference(
                self.source_name, str(self.malware["id"]), malware_url
            )
            external_references.append(external_reference)

        return external_references

    def _create_malware(self) -> Malware:
        """Create the main Malware entity."""
        description = self._get_description()
        external_references = self._create_external_references()
        capabilities = self._get_capabilities()

        return create_malware(
            name=self.malware["name"],
            created_by=self.author,
            is_family=True,
            description=description,
            capabilities=capabilities,
            created=self.created_timestamp,
            modified=self.modified_timestamp,
            confidence=self.confidence_level,
            external_references=external_references,
            object_markings=self.object_markings,
        )

    def _get_description(self) -> Optional[str]:
        """Get malware description, cleaning HTML if necessary."""
        description = self.malware.get("description")

        if description:
            cleaned_description = remove_html_tags(description)
            return cleaned_description

        return None

    def _get_capabilities(self) -> List[str]:
        """Extract capabilities from malware data."""
        capabilities = self.malware.get("capabilities", [])

        stix_capabilities = []
        for capability in capabilities:
            stix_capability = ""
            for i, char in enumerate(capability):
                if char.isupper() and i > 0:
                    stix_capability += "-"
                stix_capability += char.lower()
            stix_capabilities.append(stix_capability)

        return stix_capabilities

    def _create_targeted_sectors(self) -> List[Identity]:
        """Create sector entities from target_industries if available."""
        target_industries = self.malware.get("target_industries", [])
        if not target_industries:
            return []

        sectors = []
        for industry in target_industries:
            name = industry.get("name")
            if name and name.strip():
                sector = create_sector(name, created_by=self.author)
                sectors.append(sector)

        return sectors

    def _get_attack_patterns(self) -> List[AttackPattern]:
        """Get AttackPatterns data."""
        return self.attack_patterns

    def _create_uses_relationships(
        self, sources: List[_DomainObject], targets: List[_DomainObject]
    ) -> List[Relationship]:
        """Create 'uses' relationships between Malware and AttackPatterns."""
        return create_uses_relationships(
            self.author,
            sources,
            targets,
            self.confidence_level,
            self.object_markings,
            start_time=self.created_timestamp,
        )

    def _create_targets_relationships(
        self, sources: List[_DomainObject], targets: List[_DomainObject]
    ) -> List[Relationship]:
        """Create 'targets' relationships between Malware and Sectors."""
        return create_targets_relationships(
            self.author,
            sources,
            targets,
            self.confidence_level,
            self.object_markings,
            start_time=self.created_timestamp,
        )

    def build(self) -> Bundle:
        """Build malware bundle."""
        # Create bundle with author
        bundle_objects: List[Any] = [self.author]

        # Add object marking definitions to bundle
        bundle_objects.extend(self.object_markings)

        # Create main malware entity and add to bundle
        malware_entity = self._create_malware()
        bundle_objects.append(malware_entity)

        # Create attack patterns from MITRE data and add to bundle
        attack_patterns = self._get_attack_patterns()
        bundle_objects.extend(attack_patterns)

        # Create uses relationships between malware and attack patterns
        if attack_patterns:
            malware_uses_attack_patterns = self._create_uses_relationships(
                [malware_entity],
                attack_patterns,  # type: ignore
            )
            bundle_objects.extend(malware_uses_attack_patterns)

        # Create target sectors and add to bundle
        target_sectors = self._create_targeted_sectors()
        bundle_objects.extend(target_sectors)

        # Create targets relationships between malware and sectors
        if target_sectors:
            malware_targets_sectors = self._create_targets_relationships(
                [malware_entity],
                target_sectors,  # type: ignore
            )
            bundle_objects.extend(malware_targets_sectors)

        return Bundle(objects=bundle_objects, allow_custom=True)
