# -*- coding: utf-8 -*-
"""OpenCTI CrowdStrike vulnerability builder module."""

from typing import Any, List, Optional

from crowdstrike_feeds_services.utils import (
    create_external_reference,
    create_vulnerability,
    flexible_timestamp_to_datetime,
    remove_html_tags,
)
from stix2 import Identity  # type: ignore
from stix2 import (
    Bundle,
    ExternalReference,
    MarkingDefinition,
    Vulnerability,
)


class VulnerabilityBundleBuilder:
    """Vulnerability bundle builder."""

    def __init__(
        self,
        vulnerability: dict,
        author: Identity,
        source_name: str,
        object_markings: List[MarkingDefinition],
        confidence_level: int,
    ) -> None:
        """Initialize vulnerability bundle builder."""
        self.vulnerability = vulnerability
        self.author = author
        self.source_name = source_name
        self.object_markings = object_markings
        self.confidence_level = confidence_level

        publish_date = self.vulnerability.get("publish_date")
        self.created_timestamp = (
            flexible_timestamp_to_datetime(publish_date) if publish_date else None
        )

        updated_ts = self.vulnerability.get("updated_timestamp")
        self.modified_timestamp = (
            flexible_timestamp_to_datetime(updated_ts) if updated_ts else None
        )

    def _create_external_references(self) -> List[ExternalReference]:
        """Create external references for the vulnerability."""
        external_references = []

        cve_id = self.vulnerability.get("cve")

        if cve_id:
            cs_url = f"https://falcon.us-2.crowdstrike.com/intelligence-v2/finished-intelligence/vulnerabilities/{cve_id}"
            cs_reference = create_external_reference(self.source_name, cve_id, cs_url)
            external_references.append(cs_reference)

        return external_references

    def _build_cvss_v3_vector(self, cvss_v3: dict) -> Optional[str]:
        """Build CVSS v3 vector string from CVSS v3 base data."""
        if not cvss_v3:
            return None

        # Map attack vector
        av_map = {"Network": "N", "Adjacent": "A", "Local": "L", "Physical": "P"}
        av = av_map.get(cvss_v3.get("attack_vector", ""), "")

        # Map attack complexity
        ac_map = {"Low": "L", "High": "H"}
        ac = ac_map.get(cvss_v3.get("attack_complexity", ""), "")

        # Map privileges required
        pr_map = {"None": "N", "Low": "L", "High": "H"}
        pr = pr_map.get(cvss_v3.get("privileges_required", ""), "")

        # Map user interaction
        ui_map = {"None": "N", "Required": "R"}
        ui = ui_map.get(cvss_v3.get("user_interaction", ""), "")

        # Map scope
        s_map = {"Unchanged": "U", "Changed": "C"}
        s = s_map.get(cvss_v3.get("scope", ""), "")

        # Map impact ratings
        impact_map = {"None": "N", "Low": "L", "High": "H"}
        c = impact_map.get(cvss_v3.get("confidentiality_impact", ""), "")
        i = impact_map.get(cvss_v3.get("integrity_impact", ""), "")
        a = impact_map.get(cvss_v3.get("availability_impact", ""), "")

        # Build vector string
        if all([av, ac, pr, ui, s, c, i, a]):
            return f"CVSS:3.1/AV:{av}/AC:{ac}/PR:{pr}/UI:{ui}/S:{s}/C:{c}/I:{i}/A:{a}"

        return None

    def _build_cvss_v2_vector(self, cvss_v2: dict) -> Optional[str]:
        """Build CVSS v2 vector string from CVSS v2 base data."""
        if not cvss_v2:
            return None

        # Map access vector
        av_map = {"Local": "L", "Adjacent": "A", "Network": "N"}
        av = av_map.get(cvss_v2.get("access_vector", ""), "")

        # Map access complexity
        ac_map = {"Low": "L", "Medium": "M", "High": "H"}
        ac = ac_map.get(cvss_v2.get("access_complexity", ""), "")

        # Map authentication
        au_map = {"None": "N", "Single": "S", "Multiple": "M"}
        au = au_map.get(cvss_v2.get("authentication", ""), "")

        # Map impact ratings
        impact_map = {"None": "N", "Partial": "P", "Complete": "C"}
        c = impact_map.get(cvss_v2.get("confidentiality_impact", ""), "")
        i = impact_map.get(cvss_v2.get("integrity_impact", ""), "")
        a = impact_map.get(cvss_v2.get("availability_impact", ""), "")

        # Build vector string
        if all([av, ac, au, c, i, a]):
            return f"AV:{av}/AC:{ac}/Au:{au}/C:{c}/I:{i}/A:{a}"

        return None

    def _create_vulnerability(self) -> Vulnerability:
        """Create the main Vulnerability entity."""
        cve_id = self.vulnerability.get("cve")

        if not cve_id:
            raise ValueError("Vulnerability must have a CVE ID")

        description = self._get_description()
        external_references = self._create_external_references()

        cvss_v2_base = self.vulnerability.get("cvss_v2_base", {})
        cvss_v3_base = self.vulnerability.get("cvss_v3_base", {})

        custom_properties = {}

        if cvss_v3_base and isinstance(cvss_v3_base, dict):
            cvss_v3_score = cvss_v3_base.get("score")
            if cvss_v3_score is not None:
                custom_properties["x_opencti_base_score"] = cvss_v3_score

            cvss_v3_severity = cvss_v3_base.get("severity")
            if cvss_v3_severity:
                custom_properties["x_opencti_base_severity"] = cvss_v3_severity.lower()

            cvss_v3_vector = self._build_cvss_v3_vector(cvss_v3_base)
            if cvss_v3_vector:
                custom_properties["x_opencti_cvss_vector_string"] = cvss_v3_vector

        if cvss_v2_base and isinstance(cvss_v2_base, dict):
            cvss_v2_score = cvss_v2_base.get("score")
            if cvss_v2_score is not None:
                custom_properties["x_opencti_cvss_v2_base_score"] = cvss_v2_score

            cvss_v2_vector = self._build_cvss_v2_vector(cvss_v2_base)
            if cvss_v2_vector:
                custom_properties["x_opencti_cvss_v2_vector_string"] = cvss_v2_vector

        return create_vulnerability(
            name=cve_id,
            created_by=self.author,
            description=description,
            created=self.created_timestamp,
            modified=self.modified_timestamp,
            confidence=self.confidence_level,
            external_references=external_references,
            object_markings=self.object_markings,
            custom_properties=custom_properties,
        )

    def _get_description(self) -> Optional[str]:
        """Get vulnerability description, cleaning HTML if necessary."""
        description = self.vulnerability.get("description")

        if description:
            cleaned_description = remove_html_tags(description)
            return cleaned_description

        return None

    def build(self) -> Bundle:
        """Build vulnerability bundle."""
        bundle_objects: List[Any] = [self.author]

        bundle_objects.extend(self.object_markings)

        vulnerability_entity = self._create_vulnerability()
        bundle_objects.append(vulnerability_entity)

        return Bundle(objects=bundle_objects, allow_custom=True)
