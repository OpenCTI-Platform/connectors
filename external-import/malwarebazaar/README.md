# OpenCTI MalwareBazaar Connector

Table of Contents

- [OpenCTI MalwareBazaar Connector](#OpenCTI-MalwareBazaar-Connector)
  - [Introduction](#introduction)
    - [Difference](#difference)
  - [Installation](#installation)
    - [Requirements](#requirements)
  - [Configuration variables](#configuration-variables)
    - [OpenCTI environment variables](#opencti-environment-variables)
    - [Base connector environment variables](#base-connector-environment-variables)
    - [Connector extra parameters environment variables](#connector-extra-parameters-environment-variables)
  - [Deployment](#deployment)
    - [Docker Deployment](#docker-deployment)
    - [Manual Deployment](#manual-deployment)
  - [Usage](#usage)
  - [Behavior](#behavior)
  - [Debugging](#debugging)
  - [Additional information](#additional-information)

## Introduction

MalwareBazaar is a platform from abuse.ch and Spamhaus, dedicated to sharing malware samples with the infosec
community, antivirus vendors, and threat intelligence providers.

This connector will communicate with the Malware Bazaar API and pull data into OpenCTI.


### Difference

There is another Malware Bazaar connector named `MalwareBazaar-Recent-Additions`. The difference between MalwareBazaar versus MalwareBazaar-Recent-Additions can be summarized as the following:
- MalwareBazaar uses the newer connecter template that pushes objects onto the RabbitMQ queue for processing.
- MalwareBazaar creates a File Observable (versus an Artifact).
- MalwareBazaar does NOT upload the real malware file to your storage system (or even touch during communication with MalwareBazaar). Only JSON metadata is processed.
- Since this connector does not download the malware file, the `MALWAREBAZAAR_API_KEY` is optional, since the current implementatio of this connector only downloads recent meta data entries. This API query (`get_recent`) will permit a query and provide a response, without an API key.


## Installation

### Requirements

- OpenCTI Platform >= 6.6.12

### Configuration Variables

### OpenCTI environment variables

Below are the parameters you'll need to set for OpenCTI:

| Parameter     | config.yml | Docker environment variable | Mandatory | Description                                          |
|---------------|------------|-----------------------------|-----------|------------------------------------------------------|
| OpenCTI URL   | url        | `OPENCTI_URL`               | Yes       | The URL of the OpenCTI platform.                     |
| OpenCTI Token | token      | `OPENCTI_TOKEN`             | Yes       | The default admin token set in the OpenCTI platform. |

### Base connector environment variables

Below are the parameters you'll need to set for running the connector properly:

| Parameter       | config.yml | Docker environment variable | Default         | Mandatory | Description                                                                              |
|-----------------|------------|-----------------------------|-----------------|-----------|------------------------------------------------------------------------------------------|
| Connector ID    | id         | `CONNECTOR_ID`              | ChangeMe               | Yes       | A unique `UUIDv4` identifier for this connector instance.                                |
| Connector Type  | type       | `CONNECTOR_TYPE`            | EXTERNAL_IMPORT | Yes       | Should always be set to `EXTERNAL_IMPORT` for this connector.                            |
| Connector Name  | name       | `CONNECTOR_NAME`            | MalwareBazaar                | Yes       | Name of the connector.                                                                   |
| Duration Period       | `duration_period`   | `CONNECTOR_DURATION_PERIOD`   | PT5M           | Yes       | Determines the time interval between each launch of the connector in ISO 8601, ex: `PT5M` Will run the process every 5 minutes.        |
| Connector Scope | scope      | `CONNECTOR_SCOPE`           | StixFile                | Yes       | The scope or type of data the connector is importing, either a MIME type or Stix Object. |
| Log Level       | log_level  | `CONNECTOR_LOG_LEVEL`       | info            | Yes       | Determines the verbosity of the logs. Options are `debug`, `info`, `warn`, or `error`.   |

### Connector extra parameters environment variables

Below are the parameters you'll need to set for the connector:

| Parameter    | config.yml   | Docker environment variable | Default | Mandatory | Description |
|--------------|--------------|-----------------------------|---------|-----------|-------------|
| `malwarebazaar_api_base_url`        | `MALWAREBAZAAR_API_BASE_URL`        | Yes       | API Endpoint for MalwareBazaar - https://mb-api.abuse.ch/api/v1/ |
| `malwarebazaar_api_key`        | `MALWAREBAZAAR_API_KEY`        | No       | Not required for current implementation; Issued by MalwareBazaar - Free Auth-Key - https://bazaar.abuse.ch/api/#auth_key |
| `malwarebazaar_tlp_level`        | `MALWAREBAZAAR_TLP_LEVEL`        | Yes       | available values are: clear, white, green, amber, amber+strict, red - Default: 'clear' |
| `malwarebazaar_x_opencti_score`        | `MALWAREBAZAAR_X_OPENCTI_SCORE`        | Yes       | Range is 0 - 100, will degrade over time see: https://docs.opencti.io/latest/usage/indicators-lifecycle/#score-decay |
| `malwarebazaar_include_tags`        | `MALWAREBAZAAR_INCLUDE_TAGS`        | No       | (Optional) Only download files if any tag matches. (Comma separated... exe,dll,docm,docx,doc,xls,xlsx,xlsm,js) |
| `malwarebazaar_include_reporters`        | `MALWAREBAZAAR_INCLUDE_REPORTERS`        | No       | (Optional) Only download files uploaded by these reporters. (Comma separated) |
| `malwarebazaar_labels`        | `MALWAREBAZAAR_LABELS`        | No       | (Optional) Labels to apply to uploaded Artifacts. (Comma separated) |

## Deployment

### Docker Deployment

Before building the Docker container, you need to set the version of pycti in `requirements.txt` equal to whatever
version of OpenCTI you're running. Example, `pycti==5.12.20`. If you don't, it will take the latest version, but
sometimes the OpenCTI SDK fails to initialize.

Build a Docker Image using the provided `Dockerfile`.

Example:

```shell
# Replace the IMAGE NAME with the appropriate value
docker build . -t [IMAGE NAME]:latest
```

Make sure to replace the environment variables in `docker-compose.yml` with the appropriate configurations for your
environment. Then, start the docker container with the provided docker-compose.yml

```shell
docker compose up -d
# -d for detached
```

### Manual Deployment

Create a file `config.yml` based on the provided `config.yml.sample`.

Replace the configuration variables (especially the "**ChangeMe**" variables) with the appropriate configurations for
you environment.

Install the required python dependencies (preferably in a virtual environment):

```shell
pip3 install -r requirements.txt
```

Then, start the connector from recorded-future/src:

```shell
python3 main.py
```

## Usage

After Installation, the connector should require minimal interaction to use, and should update automatically at a regular interval specified in your `docker-compose.yml` or `config.yml` in `duration_period`.

However, if you would like to force an immediate download of a new batch of entities, navigate to:

`Data management` -> `Ingestion` -> `Connectors` in the OpenCTI platform.

Find the connector, and click on the refresh button to reset the connector's state and force a new
download of data by re-running the connector.

## Behavior

<!--
Describe how the connector functions:
* What data is ingested, updated, or modified
* Important considerations for users when utilizing this connector
* Additional relevant details
-->
This connector, for fidelity of data, requires that ingested objects have the following required fields defined:
- MD5 hash
- SHA1 hash
- SHA256 hash
- An associated reporter
- An associated filename

Entities missing these require fields will be skipped and an error entry will be sent to the error log for the connector.

## Debugging

The connector can be debugged by setting the appropiate log level.
Note that logging messages can be added using `self.helper.connector_logger,{LOG_LEVEL}("Sample message")`, i.
e., `self.helper.connector_logger.error("An error message")`.

<!-- Any additional information to help future users debug and report detailed issues concerning this connector -->

## Additional information

None
<!--
Any additional information about this connector
* What information is ingested/updated/changed
* What should the user take into account when using this connector
* ...
-->
