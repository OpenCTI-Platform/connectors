from datetime import timedelta

from connectors_sdk import (
    BaseConfigModel,
    BaseConnectorSettings,
    BaseExternalImportConnectorConfig,
    ListFromString,
)
from pydantic import Field, SecretStr


class ExternalImportConnectorConfig(BaseExternalImportConnectorConfig):
    """
    Override the `BaseExternalImportConnectorConfig` to add parameters and/or defaults
    to the configuration for connectors of type `EXTERNAL_IMPORT`.
    """

    id: str = Field(
        description="A UUID v4 to identify the connector in OpenCTI.",
        default="e18248ec-b197-4b79-ac13-b234329cdb9e",
    )
    name: str = Field(
        description="The name of the connector.",
        default="Malwarebazaar",
    )
    scope: ListFromString = Field(
        description="The scope of the connector.",
        default=[],
    )
    duration_period: timedelta = Field(
        description="The period of time to await between two runs of the connector.",
        default=timedelta(minutes=5),
    )


class MalwarebazaarConfig(BaseConfigModel):
    """
    Define parameters and/or defaults for the configuration specific to the `MalwarebazaarConnector`.
    """

    api_base_url: str = Field(
        description="MalwareBazaar API endpoint.",
        default="https://mb-api.abuse.ch/api/v1/",
    )
    api_key: SecretStr = Field(
        description="Your MalwareBazaar API key.",
    )
    tlp_level: str = Field(
        description="TLP marking for imported data.",
        default="clear",
    )
    x_opencti_score: int = Field(
        description="x_opencti_score for imported observables.",
        default=100,
    )
    include_tags: ListFromString = Field(
        description="Comma-separated file tags to include (e.g., `exe,dll`).",
        default=["exe", "dll", "docm", "docx", "doc", "xls", "xlsx", "xlsm", "js"],
    )
    include_reporters: ListFromString = Field(
        description="Comma-separated reporter names to filter by.",
        default=[],
    )
    labels: ListFromString = Field(
        description="Labels to apply to imported observables.",
        default=["malware-bazaar"],
    )


class ConnectorSettings(BaseConnectorSettings):
    """
    Override `BaseConnectorSettings` to include `ExternalImportConnectorConfig` and `MalwarebazaarConfig`.
    """

    connector: ExternalImportConnectorConfig = Field(
        default_factory=ExternalImportConnectorConfig
    )
    malwarebazaar: MalwarebazaarConfig = Field(default_factory=MalwarebazaarConfig)
