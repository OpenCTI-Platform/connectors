"""
MalwareBazaar is a platform from abuse.ch and Spamhaus, dedicated to sharing malware samples with the infosec
community, antivirus vendors, and threat intelligence providers.

This connector will communicate with the Malware Bazaar API and pull data into OpenCTI.

In order to interact with the MalwareBazaar API, you need to obtain an Auth-Key first.
If you don't have one you can get one for free here:
        https://bazaar.abuse.ch/api/#auth_key

MalwareBazaar API is rate Limited to restrict the number of file downloads on our file download API
to 2,000 per IP address/day.
        https://bazaar.abuse.ch/faq/#api-limit
"""

import requests


class ConnectorClient:
    def __init__(self, helper, config):
        """
        Represent MalwareBazaar API client interface.
        """
        self.helper = helper
        self.config = config

        # Define headers in session and update when needed, if ever extended and needing api_key, add here
        headers = {}
        self.session = requests.Session()
        self.session.headers.update(headers)

    def get_entities(self, params=None) -> dict:
        """
        Get recent additions to MalwareBazaar.

        See https://bazaar.abuse.ch/api/#latest_additions

        returns: a dict containing the recent additions in the last 60 minutes to MalwareBazaar.
        """
        try:
            return_data = []
            data = {"query": "get_recent", "selector": "time"}
            # Auth-Key not required for the 'get_recent' query for Malware Bazaar, headers can be empty
            headers = {}
            resp = requests.post(
                params["API_BASE_URL"], data=data, timeout=15, headers=headers
            )

            # Handle the response data
            recent_additions_list = resp.json()
            if "data" in recent_additions_list:
                return_data = recent_additions_list["data"]
            else:
                self.helper.connector_logger.error(
                    "Key 'data' not found in the response from MalwareBazaar API."
                )

            return return_data

        except Exception as err:
            self.helper.connector_logger.error(err)
